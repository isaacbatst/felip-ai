<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Login - Felip AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/output.css">
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/mask@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-top-color: rgba(102, 126, 234, 1);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }
    .spinner-white {
      border-color: rgba(255,255,255,0.3);
      border-top-color: #fff;
    }
  </style>
</head>
<body class="font-sans bg-gradient-to-br from-primary to-secondary min-h-screen flex items-center justify-center p-5">

  <div x-data="loginApp()" x-init="init()" class="bg-white px-8 py-10 rounded-2xl shadow-2xl text-center max-w-md w-full max-sm:px-5 max-sm:py-8">

    <!-- Step 1: Phone Input -->
    <template x-if="step === 'phone'">
      <div>
        <div class="text-5xl mb-2.5">üì±</div>
        <h1 class="text-gray-800 text-2xl mb-2 font-semibold max-sm:text-xl">Login</h1>
        <p class="text-gray-500 text-sm mb-5 leading-relaxed">
          Digite seu n√∫mero de telefone em formato internacional para receber o c√≥digo de acesso.
        </p>

        <form @submit.prevent="submitPhone()">
          <div class="mb-5">
            <input
              type="tel"
              x-model="phone"
              x-mask="+99 (99) 99999-9999"
              class="w-full py-4 px-5 text-lg text-center border-2 border-gray-200 rounded-xl outline-none transition-all focus:border-primary focus:shadow-[0_0_0_4px_rgba(102,126,234,0.1)]"
              placeholder="+55 (11) 99999-9999"
              autofocus
              required
            >
          </div>

          <button
            type="submit"
            :disabled="loading"
            class="bg-primary hover:opacity-90 w-full py-4 text-base font-semibold text-white border-none rounded-xl cursor-pointer transition-all disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <span x-show="loading" class="spinner spinner-white"></span>
            <span x-text="loading ? 'Enviando...' : 'Enviar C√≥digo'"></span>
          </button>
        </form>

        <template x-if="errorMsg">
          <div class="mt-5 p-4 rounded-xl text-sm bg-red-100 text-red-800" x-text="errorMsg"></div>
        </template>
      </div>
    </template>

    <!-- Step 2: OTP Code Input -->
    <template x-if="step === 'otp'">
      <div>
        <div class="text-5xl mb-2.5">üîê</div>
        <h1 class="text-gray-800 text-2xl mb-2 font-semibold max-sm:text-xl">C√≥digo de Acesso</h1>
        <p class="text-gray-500 text-sm mb-8 leading-relaxed">
          Digite o c√≥digo de 6 d√≠gitos enviado para seu Telegram.
        </p>

        <form @submit.prevent="submitOtp()">
          <div class="mb-5">
            <input
              type="text"
              x-model="code"
              @input="code = $event.target.value.replace(/\D/g, '')"
              class="code-input w-full py-4 px-5 text-2xl text-center tracking-[8px] border-2 border-gray-200 rounded-xl outline-none transition-all font-mono focus:border-primary focus:shadow-[0_0_0_4px_rgba(102,126,234,0.1)] max-sm:text-xl max-sm:tracking-[6px] max-sm:py-3.5 max-sm:px-4"
              inputmode="numeric"
              pattern="[0-9]*"
              maxlength="6"
              placeholder="000000"
              autocomplete="one-time-code"
              autofocus
              required
            >
          </div>

          <button
            type="submit"
            :disabled="loading"
            class="bg-primary hover:opacity-90 w-full py-4 text-base font-semibold text-white border-none rounded-xl cursor-pointer transition-all disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <span x-show="loading" class="spinner spinner-white"></span>
            <span x-text="loading ? 'Verificando...' : 'Verificar C√≥digo'"></span>
          </button>
        </form>

        <div class="timer mt-5 py-3 px-5 bg-gray-50 rounded-xl text-sm text-gray-500">
          ‚è±Ô∏è Expira em: <span x-text="countdownText"></span>
        </div>

        <div class="mt-3">
          <button
            @click="resendOtp()"
            :disabled="resendCooldown > 0 || resendLoading"
            class="text-sm font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            :class="resendCooldown > 0 || resendLoading ? 'text-gray-400' : 'text-primary hover:underline cursor-pointer'"
          >
            <span x-show="resendLoading" class="spinner" style="width:14px;height:14px;"></span>
            <span x-show="resendLoading">Reenviando...</span>
            <span x-show="!resendLoading && resendCooldown > 0" x-text="'Reenviar em ' + resendCooldown + 's'"></span>
            <span x-show="!resendLoading && resendCooldown <= 0">Reenviar c√≥digo</span>
          </button>
        </div>

        <template x-if="resendSuccess">
          <div class="mt-3 p-3 rounded-xl text-sm bg-green-100 text-green-800">C√≥digo reenviado com sucesso!</div>
        </template>

        <template x-if="errorMsg">
          <div class="mt-3 p-4 rounded-xl text-sm bg-red-100 text-red-800" x-text="errorMsg"></div>
        </template>
      </div>
    </template>

    <!-- Step 3: Error / Failure -->
    <template x-if="step === 'failed'">
      <div>
        <div class="text-5xl mb-2.5">‚ùå</div>
        <h1 class="text-gray-800 text-2xl mb-2 font-semibold max-sm:text-xl">Erro no Login</h1>
        <p class="text-gray-500 text-sm mb-8 leading-relaxed">
          Ocorreu um erro durante o processo de login. Por favor, tente novamente.
        </p>

        <template x-if="errorMsg">
          <div class="mb-5 p-4 rounded-xl text-sm bg-red-100 text-red-800" x-text="errorMsg"></div>
        </template>

        <button
          @click="retry()"
          class="bg-primary hover:opacity-90 w-full py-4 text-base font-semibold text-white border-none rounded-xl cursor-pointer transition-all"
        >
          Tentar Novamente
        </button>
      </div>
    </template>

    <p class="mt-5 text-sm text-gray-500">
      N√£o tem conta? <a href="/register" class="text-primary font-medium hover:underline">Cadastre-se</a>
    </p>
  </div>

  <script>
    function loginApp() {
      return {
        step: 'phone',
        phone: '',
        code: '',
        loading: false,
        errorMsg: '',
        countdownText: '05:00',
        countdownInterval: null,
        expiresAt: null,
        registrationToken: null,
        resendCooldown: 0,
        resendCooldownInterval: null,
        resendLoading: false,
        resendSuccess: false,
        botUsername: document.querySelector('meta[name="bot-username"]')?.content || '@FelipAIBot',

        init() {
          const params = new URLSearchParams(window.location.search);
          const phoneParam = params.get('phone');
          const tokenParam = params.get('token');
          if (phoneParam) {
            this.phone = phoneParam;
          }
          if (tokenParam) {
            this.registrationToken = tokenParam;
          }
        },

        startCountdown() {
          if (this.countdownInterval) clearInterval(this.countdownInterval);
          this.countdownInterval = setInterval(() => {
            if (!this.expiresAt) return;
            const remaining = Math.max(0, Math.floor((this.expiresAt - Date.now()) / 1000));
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            this.countdownText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            if (remaining <= 0) {
              clearInterval(this.countdownInterval);
              this.errorMsg = 'C√≥digo expirado. Por favor, tente novamente.';
              this.step = 'failed';
            }
          }, 1000);
        },

        async submitPhone() {
          this.errorMsg = '';
          const digits = this.phone.replace(/\D/g, '');

          if (!digits || digits.length < 12) {
            this.errorMsg = 'Por favor, preencha o n√∫mero completo.';
            return;
          }

          const phoneNumber = '+' + digits;

          this.loading = true;
          try {
            const res = await fetch('/login/phone', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone: phoneNumber, ...(this.registrationToken && { registrationToken: this.registrationToken }) }),
            });

            const data = await res.json();

            if (!res.ok) {
              this.errorMsg = data.message || 'Erro ao enviar c√≥digo.';
              this.loading = false;
              return;
            }

            this.expiresAt = new Date(data.expiresAt).getTime();
            this.step = 'otp';
            this.loading = false;
            this.startCountdown();
            this.startResendCooldown();
          } catch (e) {
            this.errorMsg = 'Erro de conex√£o. Verifique sua internet.';
            this.loading = false;
          }
        },

        async submitOtp() {
          this.errorMsg = '';
          const trimmed = this.code.trim();

          if (!/^\d{6}$/.test(trimmed)) {
            this.errorMsg = 'Por favor, digite o c√≥digo de 6 d√≠gitos.';
            return;
          }

          const digits = this.phone.replace(/\D/g, '');
          const phoneNumber = '+' + digits;

          this.loading = true;
          try {
            const res = await fetch('/login/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone: phoneNumber, code: trimmed }),
              credentials: 'same-origin',
            });

            const data = await res.json();

            if (!res.ok) {
              this.errorMsg = data.message || 'C√≥digo inv√°lido.';
              this.loading = false;
              return;
            }

            window.location.href = '/dashboard';
          } catch (e) {
            this.errorMsg = 'Erro de conex√£o. Verifique sua internet.';
            this.loading = false;
          }
        },

        startResendCooldown() {
          this.resendCooldown = 30;
          if (this.resendCooldownInterval) clearInterval(this.resendCooldownInterval);
          this.resendCooldownInterval = setInterval(() => {
            this.resendCooldown--;
            if (this.resendCooldown <= 0) {
              clearInterval(this.resendCooldownInterval);
              this.resendCooldownInterval = null;
            }
          }, 1000);
        },

        async resendOtp() {
          this.errorMsg = '';
          this.resendSuccess = false;
          this.resendLoading = true;

          const digits = this.phone.replace(/\D/g, '');
          const phoneNumber = '+' + digits;

          try {
            const res = await fetch('/login/phone', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone: phoneNumber, ...(this.registrationToken && { registrationToken: this.registrationToken }) }),
            });

            const data = await res.json();

            if (!res.ok) {
              this.errorMsg = data.message || 'Erro ao reenviar c√≥digo.';
              this.resendLoading = false;
              return;
            }

            this.expiresAt = new Date(data.expiresAt).getTime();
            this.startCountdown();
            this.startResendCooldown();
            this.resendLoading = false;
            this.resendSuccess = true;
            setTimeout(() => { this.resendSuccess = false; }, 3000);
          } catch (e) {
            this.errorMsg = 'Erro de conex√£o. Verifique sua internet.';
            this.resendLoading = false;
          }
        },

        retry() {
          if (this.countdownInterval) clearInterval(this.countdownInterval);
          if (this.resendCooldownInterval) clearInterval(this.resendCooldownInterval);
          this.step = 'phone';
          this.phone = '';
          this.code = '';
          this.loading = false;
          this.errorMsg = '';
          this.countdownText = '05:00';
          this.expiresAt = null;
          this.resendCooldown = 0;
          this.resendCooldownInterval = null;
          this.resendLoading = false;
          this.resendSuccess = false;
        },
      };
    }
  </script>
</body>
</html>
